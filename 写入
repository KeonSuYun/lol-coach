import os
import sys
from datetime import datetime, timedelta
from jose import jwt
from pymongo import MongoClient

# --- é…ç½®åŒºåŸŸ ---
# 1. è¯·è¾“å…¥ä½ åœ¨ www.hexcoach.gg ä¸Šæ³¨å†Œçš„ç”¨æˆ·å
TARGET_USERNAME = "admin"  # <--- è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸ºä½ çš„ç”¨æˆ·å

# 2. è·å–æ•°æ®åº“è¿æ¥
# å°è¯•ä»ç¯å¢ƒå˜é‡è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•æœ¬åœ°è¿æ¥
MONGO_URL = os.getenv("MONGODB_URI", "mongodb://127.0.0.1:27017/hexcoach")
SECRET_KEY = os.getenv("SECRET_KEY", "hexcoach-secret-key-2024") # è¿™é‡Œéœ€è¦å’Œä½  server.py é‡Œçš„ä¿æŒä¸€è‡´
ALGORITHM = "HS256"

def generate_token():
    print(f"ğŸ”Œ æ­£åœ¨è¿æ¥æ•°æ®åº“: {MONGO_URL}...")
    try:
        client = MongoClient(MONGO_URL)
        db = client.get_default_database()
        users_collection = db.users
    except Exception as e:
        print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return

    # 1. æŸ¥æ‰¾ç”¨æˆ·
    user = users_collection.find_one({"username": TARGET_USERNAME})
    if not user:
        print(f"âŒ é”™è¯¯: æ‰¾ä¸åˆ°ç”¨æˆ· '{TARGET_USERNAME}'ã€‚")
        print("   è¯·å…ˆå» www.hexcoach.gg æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œç„¶åå†è¿è¡Œæ­¤è„šæœ¬ã€‚")
        return

    # 2. å‡çº§æƒé™ä¸º admin
    print(f"ğŸ†™ æ­£åœ¨å°†ç”¨æˆ· '{TARGET_USERNAME}' å‡çº§ä¸ºç®¡ç†å‘˜ (admin)...")
    users_collection.update_one(
        {"_id": user["_id"]}, 
        {"$set": {"role": "admin"}}
    )
    print("âœ… æƒé™å‡çº§æˆåŠŸï¼")

    # 3. ç”Ÿæˆé•¿æ•ˆ Token (10å¹´æœ‰æ•ˆ)
    # è¿™æ ·ä½ å°±ä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°è·å–äº†
    expire = datetime.utcnow() + timedelta(days=3650)
    to_encode = {
        "sub": TARGET_USERNAME,
        "role": "admin",
        "exp": expire
    }
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

    print("\n" + "="*50)
    print("ğŸ”‘ ä½ çš„ç®¡ç†å‘˜ Token (è¯·å¤åˆ¶ä¸‹æ–¹å­—ç¬¦ä¸²):")
    print("="*50)
    print(encoded_jwt)
    print("="*50 + "\n")
    print("ğŸ’¡ ä½¿ç”¨æ–¹æ³•: å°†ä¸Šé¢çš„ Token ç²˜è´´åˆ°çƒ­æ›´æ–°æ§åˆ¶å°çš„ 'ç®¡ç†å‘˜ Token' æ¡†ä¸­å³å¯ã€‚")

if __name__ == "__main__":
    # å¦‚æœä½ ä¹Ÿä¸Šä¼ äº†è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥ python get_admin_token.py
    # æˆ–è€…ç›´æ¥åœ¨ python äº¤äº’å¼å‘½ä»¤è¡Œé‡Œç²˜è´´ä¸Šé¢çš„ä»£ç 
    generate_token()